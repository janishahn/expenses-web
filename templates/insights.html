{% extends "base.html" %}
{% block content %}
{% from "macros.html" import icon %}

<section id="insights-filters" class="space-y-6">
    <div class="space-y-2">
        <p class="metric-eyebrow text-xs text-slate-500 dark:text-slate-400">Analytics</p>
        <h1 class="text-3xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Insights</h1>
        <p class="text-slate-500 dark:text-slate-400">Trends, top categories, and budget performance for the selected period.</p>
    </div>

    <form id="insights-filter-form" class="card shadow-hover">
        <input type="hidden" name="start" value="{{ period.start }}">
        <input type="hidden" name="end" value="{{ period.end }}">
        <input type="hidden" name="period" value="{{ period.slug }}">
        <input type="hidden" name="type" value="{{ filters.type.value if filters.type else '' }}">
        <input type="hidden" name="tag" value="{{ filters.tag_id or '' }}">
        <input type="hidden" name="trend_category" value="{{ trend_category_id or '' }}">
        <input type="hidden" name="budget_month" value="{{ budget_month }}">

        <div class="card-body space-y-3">
            {% set ns = namespace(tag_label="All", trend_label="Selected") %}
            {% if filters.tag_id %}
            {% for t in tags %}
            {% if t.id == filters.tag_id %}
            {% set ns.tag_label = t.name %}
            {% endif %}
            {% endfor %}
            {% endif %}
            {% if trend_category_id %}
            {% for category in categories %}
            {% if category.id == trend_category_id %}
            {% set ns.trend_label = category.type.value|title ~ " · " ~ category.name %}
            {% endif %}
            {% endfor %}
            {% endif %}

            <div class="transactions-filter-summary">
                <div class="transactions-filter-summary-left">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Filters</p>
                    <div class="transactions-filter-chips" aria-label="Applied filters">
                        <span class="pill" data-insights-filter-pill="date">Date: {{ period.start|eurodate }} → {{ period.end|eurodate }}</span>
                        <span class="pill" data-insights-filter-pill="type">Type: {% if filters.type %}{{ filters.type.value|title }}{% else %}All{% endif %}</span>
                        <span class="pill" data-insights-filter-pill="tag">Tag: {{ ns.tag_label }}</span>
                        <span class="pill" data-insights-filter-pill="trend">Trend: {{ ns.trend_label }}</span>
                        <span class="pill" data-insights-filter-pill="budget">Budget: {{ budget_month }}</span>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm" data-filter-toggle aria-expanded="false" aria-controls="insights-filter-panel">
                    <span data-filter-toggle-label>Show filters</span>
                    {{ icon("chevron-down", class="icon filter-toggle-icon") }}
                </button>
            </div>

            <div id="insights-filter-panel" class="transactions-filter-panel" data-expanded="false" aria-hidden="true" inert>
                <div class="pt-4 space-y-6">
                    <div class="flex flex-col lg:flex-row lg:items-end gap-4">
                        <div class="flex-1 space-y-2">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Quick ranges</p>
                            <div class="chip-group" role="group" aria-label="Period presets">
                                <button type="button" class="chip" data-period-chip="this_month">This Month</button>
                                <button type="button" class="chip" data-period-chip="last_month">Last Month</button>
                                <button type="button" class="chip" data-period-chip="all">All time</button>
                                <button type="button" class="chip" data-period-chip="custom">Custom</button>
                            </div>
                        </div>
                        <div class="w-full lg:max-w-md space-y-2">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Date range</p>
                            <div id="insights-range-picker"></div>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row lg:items-end gap-4">
                        <div class="flex-1 space-y-2">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Type</p>
                            <div class="chip-group" role="group">
                                <button type="button" class="chip" data-type-chip="">All</button>
                                <button type="button" class="chip" data-type-chip="expense">Expense</button>
                                <button type="button" class="chip" data-type-chip="income">Income</button>
                            </div>
                        </div>
                        <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
                            Tag filter (optional)
                            <select class="select" data-tag-select>
                                <option value="">All</option>
                                {% for t in tags %}
                                <option value="{{ t.id }}" {% if filters.tag_id == t.id %}selected{% endif %}>{{ t.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
                            Trend category
                            <select class="select" data-trend-category>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if trend_category_id == category.id %}selected{% endif %}>
                                    {{ category.type.value|title }} · {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
                            Budget month
                            <input type="month" class="input" data-budget-month value="{{ budget_month }}">
                        </label>
                        <div class="flex items-end">
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                Tag pages provide deep dives. Insights surfaces top tags and links into them.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</section>

<section class="space-y-6">
    {% include "components/insights_monthly_series.html" %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% include "components/insights_category_trend.html" %}
        {% include "components/insights_top_categories.html" %}
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% include "components/insights_deltas.html" %}
        {% include "components/insights_budget.html" %}
    </div>
    {% include "components/insights_top_tags.html" %}
</section>

<script>
(function () {
    const hub = document.getElementById("insights-filters");
    const form = document.getElementById("insights-filter-form");
    if (!hub || !form) return;

    const filterPanel = document.getElementById("insights-filter-panel");
    const filterToggleBtn = form.querySelector("[data-filter-toggle]");
    const filterToggleLabel = filterToggleBtn ? filterToggleBtn.querySelector("[data-filter-toggle-label]") : null;
    const summaryDate = form.querySelector("[data-insights-filter-pill='date']");
    const summaryType = form.querySelector("[data-insights-filter-pill='type']");
    const summaryTag = form.querySelector("[data-insights-filter-pill='tag']");
    const summaryTrend = form.querySelector("[data-insights-filter-pill='trend']");
    const summaryBudget = form.querySelector("[data-insights-filter-pill='budget']");

    const typeChips = Array.from(document.querySelectorAll("[data-type-chip]"));
    const periodChips = Array.from(document.querySelectorAll("[data-period-chip]"));
    const tagSelect = document.querySelector("[data-tag-select]");
    const trendSelect = document.querySelector("[data-trend-category]");
    const budgetMonthInput = document.querySelector("[data-budget-month]");

    let rangeApi = null;
    let pickerMounted = false;
    let openCustomWhenReady = false;

    function formatEuroDate(isoDate) {
        if (!isoDate) return "";
        const parts = isoDate.split("-");
        if (parts.length !== 3) return isoDate;
        return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }

    function labelType(value) {
        if (value === "expense") return "Expense";
        if (value === "income") return "Income";
        return "All";
    }

    function labelTag(value) {
        if (!tagSelect) return value || "All";
        for (const opt of Array.from(tagSelect.options || [])) {
            if (opt.value === (value || "")) return opt.textContent || "All";
        }
        return value || "All";
    }

    function labelTrend(value) {
        if (!trendSelect) return value || "Selected";
        for (const opt of Array.from(trendSelect.options || [])) {
            if (opt.value === (value || "")) return opt.textContent || "Selected";
        }
        return value || "Selected";
    }

    function updateSummary(detail) {
        if (summaryDate) summaryDate.textContent = `Date: ${formatEuroDate(detail.start)} → ${formatEuroDate(detail.end)}`;
        if (summaryType) summaryType.textContent = `Type: ${labelType(detail.type)}`;
        if (summaryTag) summaryTag.textContent = `Tag: ${labelTag(detail.tag)}`;
        if (summaryTrend) summaryTrend.textContent = `Trend: ${labelTrend(detail.trend_category)}`;
        if (summaryBudget) summaryBudget.textContent = `Budget: ${detail.budget_month || ""}`;
    }

    function setFilterPanelExpanded(expanded, animate = true) {
        if (!filterPanel || !filterToggleBtn) return;
        filterToggleBtn.setAttribute("aria-expanded", expanded ? "true" : "false");
        filterPanel.setAttribute("aria-hidden", expanded ? "false" : "true");
        form.classList.toggle("filters-expanded", expanded);
        filterPanel.dataset.expanded = expanded ? "true" : "false";
        filterPanel.classList.toggle("is-expanded", expanded);
        if (filterToggleLabel) filterToggleLabel.textContent = expanded ? "Hide filters" : "Show filters";

        if (expanded) {
            filterPanel.removeAttribute("inert");
            ensurePickerMounted();
        } else {
            filterPanel.setAttribute("inert", "");
        }

        const controls = filterPanel.querySelectorAll("input, select, textarea, button");
        controls.forEach((el) => {
            el.disabled = !expanded;
        });

        if (expanded) {
            if (!animate) {
                filterPanel.style.maxHeight = "none";
                return;
            }
            filterPanel.style.maxHeight = "0px";
            filterPanel.offsetHeight;
            filterPanel.style.maxHeight = `${filterPanel.scrollHeight}px`;
            const onEnd = (event) => {
                if (event.propertyName !== "max-height") return;
                filterPanel.style.maxHeight = "none";
            };
            filterPanel.addEventListener("transitionend", onEnd, { once: true });
            return;
        }

        if (!animate) {
            filterPanel.style.maxHeight = "0px";
            return;
        }
        const currentHeight = filterPanel.scrollHeight;
        filterPanel.style.maxHeight =
            filterPanel.style.maxHeight === "none" ? `${currentHeight}px` : filterPanel.style.maxHeight;
        filterPanel.offsetHeight;
        filterPanel.style.maxHeight = "0px";
    }

    function refreshFilterPanelHeight() {
        if (!filterPanel) return;
        if (filterPanel.dataset.expanded !== "true") return;
        filterPanel.style.maxHeight = `${filterPanel.scrollHeight}px`;
    }

    function toLocalIso(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    function emitFiltersChanged() {
        const detail = {
            start: form.elements["start"].value,
            end: form.elements["end"].value,
            period: form.elements["period"].value,
            type: form.elements["type"].value,
            tag: form.elements["tag"].value,
            trend_category: form.elements["trend_category"].value,
            budget_month: form.elements["budget_month"].value,
        };
        updateSummary(detail);
        hub.dispatchEvent(new CustomEvent("filtersChanged", { bubbles: true, detail }));

        const params = new URLSearchParams(window.location.search);
        params.set("period", detail.period);
        params.set("start", detail.start);
        params.set("end", detail.end);
        if (detail.type) params.set("type", detail.type); else params.delete("type");
        if (detail.tag) params.set("tag", detail.tag); else params.delete("tag");
        if (detail.trend_category) params.set("trend_category", detail.trend_category); else params.delete("trend_category");
        if (detail.budget_month) params.set("budget_month", detail.budget_month); else params.delete("budget_month");
        window.history.replaceState({}, "", `${window.location.pathname}?${params.toString()}`);
        window.ui?.syncNavPeriodLinks?.();
    }

    function ensurePickerMounted() {
        if (pickerMounted) return;
        pickerMounted = true;
        mountPicker();
    }

    function mountPicker() {
        if (!window.mountDateRangePicker) {
            window.setTimeout(mountPicker, 50);
            return;
        }
        window.mountDateRangePicker("insights-range-picker", {
            initialStart: form.elements["start"].value,
            initialEnd: form.elements["end"].value,
            onApply: (s, e) => {
                form.elements["start"].value = s;
                form.elements["end"].value = e;
                form.elements["period"].value = "custom";
                emitFiltersChanged();
                refreshFilterPanelHeight();
            },
            onExpose: (api) => {
                rangeApi = api;
                if (openCustomWhenReady) {
                    openCustomWhenReady = false;
                    rangeApi.open();
                }
                refreshFilterPanelHeight();
            },
        });
    }

    function syncPeriodChips(slug) {
        periodChips.forEach((chip) => chip.classList.toggle("is-active", chip.dataset.periodChip === slug));
    }

    function setPeriod(slug) {
        const today = new Date();
        let startDate = null;
        let endDate = null;

        if (slug === "this_month") {
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        } else if (slug === "last_month") {
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
        } else if (slug === "all") {
            startDate = new Date(1970, 0, 1);
            endDate = today;
        } else if (slug === "custom" && rangeApi) {
            rangeApi.open();
        } else if (slug === "custom") {
            ensurePickerMounted();
            openCustomWhenReady = true;
        }

        form.elements["period"].value = slug;
        syncPeriodChips(slug);

        if (startDate && endDate) {
            const startStr = toLocalIso(startDate);
            const endStr = toLocalIso(endDate);
            form.elements["start"].value = startStr;
            form.elements["end"].value = endStr;
            if (rangeApi) {
                rangeApi.setRange(startStr, endStr);
                rangeApi.close();
            }
            emitFiltersChanged();
            refreshFilterPanelHeight();
        } else if (slug === "custom") {
            emitFiltersChanged();
            refreshFilterPanelHeight();
        }
    }

    function syncTypeChips(value) {
        typeChips.forEach((chip) => chip.classList.toggle("is-active", chip.dataset.typeChip === value));
    }

    typeChips.forEach((chip) => {
        chip.addEventListener("click", () => {
            form.elements["type"].value = chip.dataset.typeChip;
            syncTypeChips(chip.dataset.typeChip);
            emitFiltersChanged();
        });
    });
    periodChips.forEach((chip) => chip.addEventListener("click", () => setPeriod(chip.dataset.periodChip)));

    tagSelect?.addEventListener("change", () => {
        form.elements["tag"].value = tagSelect.value;
        emitFiltersChanged();
        refreshFilterPanelHeight();
    });
    trendSelect?.addEventListener("change", () => {
        form.elements["trend_category"].value = trendSelect.value;
        emitFiltersChanged();
        refreshFilterPanelHeight();
    });
    budgetMonthInput?.addEventListener("change", () => {
        form.elements["budget_month"].value = budgetMonthInput.value;
        emitFiltersChanged();
        refreshFilterPanelHeight();
    });

    if (filterPanel) {
        filterPanel.style.maxHeight = "0px";
        setFilterPanelExpanded(false, false);
    }

    if (filterToggleBtn) {
        const prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        filterToggleBtn.addEventListener("click", () => {
            const expanded = filterToggleBtn.getAttribute("aria-expanded") === "true";
            setFilterPanelExpanded(!expanded, !prefersReducedMotion);
            if (!expanded) window.setTimeout(refreshFilterPanelHeight, 0);
        });
    }

    updateSummary({
        start: form.elements["start"].value,
        end: form.elements["end"].value,
        period: form.elements["period"].value,
        type: form.elements["type"].value,
        tag: form.elements["tag"].value,
        trend_category: form.elements["trend_category"].value,
        budget_month: form.elements["budget_month"].value,
    });
    syncPeriodChips(form.elements["period"].value);
    syncTypeChips(form.elements["type"].value);
})();
</script>
{% endblock %}
