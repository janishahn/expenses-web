{% extends "base.html" %}
{% block content %}
<section>
    <h1>Transactions</h1>
    <form method="get" class="grid two">
        <label>Type
            <select name="type">
                <option value="">All</option>
                {% for t in TransactionType %}
                <option value="{{ t.value }}" {% if filters.type == t %}selected{% endif %}>{{ t.value.title() }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Category
            <select name="category">
                <option value="">All</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if filters.category_id == category.id %}selected{% endif %}>
                    {{ category.name }} ({{ category.type.value }})
                </option>
                {% endfor %}
            </select>
        </label>
        <label>Search
            <input type="text" name="q" value="{{ filters.query or '' }}" placeholder="Notes contain...">
        </label>
        <label>Period start
            <input type="date" name="start" value="{{ period.start }}">
        </label>
        <label>Period end
            <input type="date" name="end" value="{{ period.end }}">
        </label>
        <label>Preset
            <select name="period">
                <option value="this_month" {% if period.slug == 'this_month' %}selected{% endif %}>This Month</option>
                <option value="last_month" {% if period.slug == 'last_month' %}selected{% endif %}>Last Month</option>
                <option value="custom" {% if period.slug == 'custom' %}selected{% endif %}>Custom</option>
            </select>
        </label>
        <button class="button" type="submit">Apply</button>
    </form>
    <div style="margin-top:1rem;">
        <a class="button secondary" href="/transactions/export.csv?{{ period_query }}{% if filter_query %}&{{ filter_query }}{% endif %}">
            Export CSV
        </a>
    </div>
</section>

<section id="transactions-table">
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Note</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for txn in transactions %}
            <tr>
                <td>{{ txn.date }}</td>
                <td>{{ txn.type.value }}</td>
                <td>{{ txn.category.name if txn.category else "-" }}</td>
                <td>{{ txn.amount_cents|currency }} â‚¬</td>
                <td>{{ txn.note or "" }}</td>
                <td>
                    <form hx-post="/transactions/{{ txn.id }}/delete" hx-swap="none">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="button secondary" type="submit">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">No transactions.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="grid two">
        <div>
            {% if page > 1 %}
            <a class="button secondary" href="?page={{ page - 1 }}&{{ period_query }}{% if filter_query %}&{{ filter_query }}{% endif %}">Previous</a>
            {% endif %}
        </div>
        <div style="text-align:right;">
            {% if has_more %}
            <a class="button secondary" href="?page={{ page + 1 }}&{{ period_query }}{% if filter_query %}&{{ filter_query }}{% endif %}">Next</a>
            {% endif %}
        </div>
    </div>
</section>

<section>
    <h3>CSV Import</h3>
    <form hx-post="/transactions/import/preview" hx-target="#csv-preview" hx-swap="innerHTML" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="file" name="file" accept=".csv">
        <button class="button" type="submit">Preview</button>
    </form>
    <form hx-post="/transactions/import/commit" hx-target="#csv-status" hx-swap="innerHTML" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="file" name="file" accept=".csv">
        <button class="button" type="submit">Import</button>
    </form>
    <div id="csv-preview"></div>
    <div id="csv-status"></div>
</section>
{% endblock %}
