{% extends "base.html" %}
{% block content %}
<div style="position: sticky; top: 0; background: white; z-index: 100; padding: 1rem 0; border-bottom: 1px solid #e5e5e5; margin-bottom: 1rem;">
    <h1 style="margin-bottom: 1rem;">Transactions</h1>
    <form method="get" class="grid two">
        <label>Type
            <select name="type">
                <option value="">All</option>
                {% for t in TransactionType %}
                <option value="{{ t.value }}" {% if filters.type == t %}selected{% endif %}>{{ t.value.title() }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Category
            <select name="category">
                <option value="">All</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if filters.category_id == category.id %}selected{% endif %}>
                    {{ category.name }} ({{ category.type.value }})
                </option>
                {% endfor %}
            </select>
        </label>
        <label>Search
            <input type="text" name="q" value="{{ filters.query or '' }}" placeholder="Notes contain...">
        </label>
        <label>Period start
            <input type="date" name="start" value="{{ period.start }}">
        </label>
        <label>Period end
            <input type="date" name="end" value="{{ period.end }}">
        </label>
        <label>Preset
            <select name="period">
                <option value="this_month" {% if period.slug == 'this_month' %}selected{% endif %}>This Month</option>
                <option value="last_month" {% if period.slug == 'last_month' %}selected{% endif %}>Last Month</option>
                <option value="custom" {% if period.slug == 'custom' %}selected{% endif %}>Custom</option>
            </select>
        </label>
        <button class="button" type="submit">Apply</button>
    </form>
    <div style="margin-top: 1rem;">
        <a class="button secondary" href="/transactions/export.csv?{{ period_query }}{% if filter_query %}&{{ filter_query }}{% endif %}">
            Export CSV
        </a>
    </div>
</div>

<div style="position: fixed; bottom: 2rem; right: 2rem; z-index: 100;">
    <a href="/" class="button" style="border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">+</a>
</div>

<section id="transactions-list">
    <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
        {% for txn in transactions %}
        <div style="background: white; border: 1px solid #e5e5e5; border-radius: 8px; padding: 1rem; display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: center;">
            <div>
                <div style="font-weight: 600; font-size: 1.1rem;">
                    {{ txn.category.name if txn.category else "-" }}
                    {% if txn.kind == 'adjustment' %}
                    <span style="font-size: 0.75rem; color: #666; background: #f0f0f0; padding: 0.125rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">ADJ</span>
                    {% endif %}
                </div>
                <div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">
                    {{ txn.date }}
                    {% if txn.note %}
                    <div style="margin-top: 0.25rem;">{{ txn.note }}</div>
                    {% endif %}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600; font-size: 1.2rem; {% if txn.type.value == 'expense' %}color: #dc2626;{% else %}color: #16a34a;{% endif %}">
                    {% if txn.type.value == 'expense' %}-{% endif %}{{ txn.amount_cents|currency }} â‚¬
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                    {{ txn.type.value.title() }}
                </div>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            No transactions found.
        </div>
        {% endfor %}
    </div>
    <div class="grid two">
        <div>
            {% if page > 1 %}
            <a class="button secondary" href="?page={{ page - 1 }}&{{ period_query }}{% if filter_query %}&{{ filter_query }}{% endif %}">Previous</a>
            {% endif %}
        </div>
        <div style="text-align:right;">
            {% if has_more %}
            <a class="button secondary" href="?page={{ page + 1 }}&{{ period_query }}{% if filter_query %}&{{ filter_query }}{% endif %}">Next</a>
            {% endif %}
        </div>
    </div>
</section>

<section>
    <h3>CSV Import</h3>
    <form hx-post="/transactions/import/preview" hx-target="#csv-preview" hx-swap="innerHTML" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="file" name="file" accept=".csv">
        <button class="button" type="submit">Preview</button>
    </form>
    <form hx-post="/transactions/import/commit" hx-target="#csv-status" hx-swap="innerHTML" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="file" name="file" accept=".csv">
        <button class="button" type="submit">Import</button>
    </form>
    <div id="csv-preview"></div>
    <div id="csv-status"></div>
</section>
{% endblock %}
