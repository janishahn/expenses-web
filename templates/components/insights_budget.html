{% from "macros.html" import icon %}
<div id="insights-budget"
     hx-get="/components/insights/budget"
     hx-trigger="filtersChanged from:#insights-filters"
     hx-include="#insights-filter-form"
     hx-swap="outerHTML"
     class="card shadow-hover">
    <div class="card-header flex items-center justify-between">
        <div>
            <p class="metric-eyebrow">Budget</p>
            <h3 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Budget vs actual</h3>
        </div>
        <span class="pill">{{ budget_month }}</span>
    </div>
    <div class="separator"></div>
    <div class="card-body space-y-3">
        {% if budget_effective %}
        {% for row in budget_effective %}
        {% set p = budget_progress.get(row.scope_category_id, {}) %}
        {% set spent = p.get('spent_cents', 0) %}
        {% set remaining = p.get('remaining_cents', 0) %}
        {% set over = remaining < 0 %}
        <div class="p-4 rounded-xl border border-border bg-slate-50/60 dark:bg-slate-800/40 space-y-2">
            <div class="flex items-center justify-between gap-4">
                <div class="min-w-0">
                    <p class="font-semibold text-slate-800 dark:text-slate-100 truncate">{{ row.scope_label }}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                        <span class="pill">{{ row.source|title }}</span>
                        Budget {{ row.amount_cents|currency }} €
                    </p>
                </div>
                <div class="text-right">
                    <p class="tabular text-rose-500">Spent {{ spent|currency }} €</p>
                    <p class="tabular {% if over %}text-rose-500{% else %}text-emerald-500{% endif %}">
                        {% if over %}Over by{% else %}Left{% endif %} {{ remaining|abs|currency }} €
                    </p>
                </div>
            </div>
            <div class="h-2 bg-slate-100 dark:bg-slate-900 rounded-full overflow-hidden">
                {% set pct = (spent / row.amount_cents * 100) if row.amount_cents else 0 %}
                {% if pct > 100 %}{% set pct = 100 %}{% endif %}
                <div class="h-2 {% if over %}bg-rose-500{% else %}bg-emerald-500{% endif %} rounded-full" style="width: {{ pct }}%"></div>
            </div>
            {% if row.source == "template" %}
            <p class="text-xs text-slate-500 dark:text-slate-400">Edit templates from the Budgets → Templates tab.</p>
            {% else %}
            <form method="post" action="/budgets/overrides/{{ row.source_id }}/delete?month={{ budget_month }}" class="flex justify-end">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-ghost btn-sm">Delete override</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            {{ icon("target", size=56) }}
            <p class="font-semibold text-slate-800 dark:text-slate-100">No budgets set</p>
            <p class="text-sm text-slate-500 dark:text-slate-400">Create monthly overrides or recurring templates from the Budgets page.</p>
            <a href="/budgets?view=month&month={{ budget_month }}" class="btn btn-primary btn-sm">Go to budgets</a>
        </div>
        {% endif %}
    </div>
</div>
