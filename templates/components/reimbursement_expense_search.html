{% from "macros.html" import icon %}
<div class="space-y-3">
    {% if query %}
    <p class="text-xs text-slate-500 dark:text-slate-400">Results for “{{ query }}”</p>
    {% endif %}

    {% if results %}
    <ul class="space-y-2">
        {% for row in results %}
        {% set expense = row.expense %}
        <li class="rounded-xl border border-border p-3">
            <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                    <p class="font-semibold text-slate-800 dark:text-slate-100 truncate">
                        {{ expense.note or (expense.category.name if expense.category else 'Expense') }}
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                        {{ expense.date|eurodate }} • {{ expense.category.name if expense.category else 'Uncategorized' }}
                    </p>
                </div>
                <p class="tabular font-semibold text-rose-500">-{{ expense.amount_cents|currency }} €</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-3">
                <div class="rounded-lg bg-slate-50 dark:bg-slate-900 p-2">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Already reimbursed</p>
                    <p class="tabular text-sm font-semibold text-emerald-600">{{ row.reimbursed_total_cents|currency }} €</p>
                </div>
                <div class="rounded-lg bg-slate-50 dark:bg-slate-900 p-2">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Remaining</p>
                    <p class="tabular text-sm font-semibold text-slate-800 dark:text-slate-100">{{ row.remaining_unreimbursed_cents|currency }} €</p>
                </div>
            </div>

            <form hx-post="/reimbursements/{{ reimbursement_id }}/allocate" hx-swap="none"
                  class="mt-3 flex flex-col sm:flex-row gap-2 sm:items-end">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="next" value="/transactions/{{ reimbursement_id }}/edit">
                <input type="hidden" name="expense_transaction_id" value="{{ expense.id }}">
                <label class="flex-1 space-y-1 text-sm font-semibold text-slate-600 dark:text-slate-300">
                    Allocate amount
                    <input type="text" name="amount"
                           value="{% if row.suggested_amount_cents > 0 %}{{ '%.2f' % (row.suggested_amount_cents / 100) }}{% endif %}"
                           inputmode="decimal" class="input" required>
                </label>
                <button type="submit"
                        class="btn btn-primary btn-sm w-full sm:w-auto"
                        {% if row.suggested_amount_cents <= 0 %}disabled{% endif %}>
                    {{ icon("link", class="icon") }}
                    Allocate
                </button>
            </form>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="rounded-xl border border-border p-4 text-sm text-slate-500 dark:text-slate-400">
        No matching expenses.
    </div>
    {% endif %}
</div>
