{% extends "base.html" %}
{% from "macros.html" import icon %}
{% block content %}
<section class="space-y-6">
    <div class="space-y-2">
        <p class="metric-eyebrow text-xs text-slate-500 dark:text-slate-400">Control center</p>
        <h1 class="text-3xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Admin</h1>
        <p class="text-slate-500 dark:text-slate-400">Back up data, export archives, and keep the ledger tidy.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <article class="card shadow-hover space-y-0">
            <div class="info-card-accent" style="background: #6366f1;"></div>
            <div class="card-body space-y-3">
                <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Database Backups</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Download a complete SQLite dump so you can restore everything if something goes sideways.</p>
                <a href="/admin/download-db" class="btn btn-primary btn-lg w-full">Download backup</a>
            </div>
        </article>

        <article class="card shadow-hover space-y-0">
            <div class="info-card-accent" style="background: #22c55e;"></div>
            <div class="card-body space-y-3">
                <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Export Transactions</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Grab a CSV of every transaction for auditing or to bring into spreadsheets.</p>
                <form method="post" action="/admin/export-csv">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-primary btn-lg w-full">Export CSV</button>
                </form>
            </div>
        </article>

        <article class="card shadow-hover space-y-0">
            <div class="info-card-accent" style="background: #38bdf8;"></div>
            <div class="card-body space-y-3">
                <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Import</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Import transactions from CSV or a legacy SQLite database.</p>
                <a href="/admin/import" class="btn btn-secondary btn-lg w-full">Open importer</a>
            </div>
        </article>

        <article class="card shadow-hover space-y-0" id="balance-anchors">
            <div class="info-card-accent bg-sky-500"></div>
	            <div class="card-body space-y-3">
	                <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Balance Snapshots</h2>
	                <p class="text-sm text-slate-500 dark:text-slate-400">
	                    Reconcile your account balance at a specific moment. Transactions are applied before/after this timestamp.
	                    If you later change transaction timestamps, reconcile again.
	                </p>
	                <div class="text-sm text-slate-600 dark:text-slate-300">
	                    Current balance (as of now): <span class="font-semibold">{{ current_balance|currency }} €</span>
	                </div>

	                <form method="post" action="/balance-anchors" class="space-y-3">
	                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
	                    <input type="hidden" name="next" value="/admin#balance-anchors">
	                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
	                        <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
	                            As of
	                            <input type="datetime-local" name="as_of_at" value="{{ now_local() }}" class="input" required>
	                        </label>
	                        <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
	                            Balance
	                            <input type="text" name="balance" placeholder="-12.34" inputmode="decimal" class="input" required>
	                        </label>
	                    </div>
                    <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
                        Note (optional)
                        <input type="text" name="note" class="input" maxlength="200">
                    </label>
                    <button type="submit" class="btn btn-primary btn-lg w-full">Save snapshot</button>
                </form>

                {% if balance_anchors %}
                <div class="separator"></div>
                <div class="space-y-2">
	                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Saved snapshots</p>
	                    <div class="table-wrapper">
	                        <table class="table">
	                            <thead>
	                                <tr>
	                                    <th>When</th>
	                                    <th class="text-right">Balance</th>
	                                    <th>Note</th>
	                                    <th></th>
	                                </tr>
	                            </thead>
	                            <tbody>
	                                {% for anchor in balance_anchors %}
	                                <tr>
	                                    <td>{{ anchor.as_of_at.strftime('%Y-%m-%d %H:%M') }}</td>
	                                    <td class="text-right tabular font-semibold">{{ anchor.balance_cents|currency }} €</td>
	                                    <td class="text-slate-500 dark:text-slate-400">{{ anchor.note or "" }}</td>
	                                    <td class="text-right">
	                                        <div class="inline-flex items-center gap-1 justify-end">
	                                            <button type="button"
	                                                    class="btn btn-ghost btn-icon"
	                                                    data-tooltip="Edit snapshot"
	                                                    data-open-balance-anchor-edit
	                                                    data-anchor-id="{{ anchor.id }}"
	                                                    data-anchor-at="{{ anchor.as_of_at.strftime('%Y-%m-%dT%H:%M') }}"
	                                                    data-anchor-balance-cents="{{ anchor.balance_cents }}"
	                                                    data-anchor-note="{{ (anchor.note or '')|e }}">
	                                                {{ icon("pencil", class="icon") }}
	                                            </button>
                                            <form method="post" action="/balance-anchors/{{ anchor.id }}/delete" onsubmit="return confirm('Delete this balance snapshot?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="next" value="/admin#balance-anchors">
                                                <button type="submit" class="btn btn-ghost btn-icon" data-tooltip="Delete snapshot">
                                                    {{ icon("trash-2", class="icon") }}
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </article>

        <article class="card shadow-hover space-y-0">
            <div class="info-card-accent bg-rose-500"></div>
            <div class="card-body space-y-3">
                <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Danger Zone</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Purge soft-deleted transactions older than a safe window to keep the database lean.</p>
                <form method="post"
                      action="/admin/purge-deleted"
                      hx-post="/admin/purge-deleted"
                      hx-swap="none"
                      hx-on::afterRequest="window.ui?.showToast('Deleted transactions purged')"
                      onsubmit="return confirm('Purge deleted transactions? This cannot be undone.')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <label class="space-y-1 text-xs font-semibold text-slate-500 dark:text-slate-400">
                        Older than (days)
                        <input type="number" name="days" value="30" min="1" max="365" class="input">
                    </label>
                    <button type="submit" class="btn btn-primary btn-lg w-full mt-3">Purge now</button>
                </form>
            </div>
        </article>

        <article class="card shadow-hover space-y-0">
            <div class="info-card-accent" style="background: #fb923c;"></div>
            <div class="card-body space-y-3">
                <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">Rebuild Rollups</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Recalculate monthly aggregates from the transaction ledger (use after imports or large backfills).</p>
                <form method="post"
                      action="/admin/rebuild-rollups"
                      hx-post="/admin/rebuild-rollups"
                      hx-swap="none"
                      hx-on::afterRequest="window.ui?.showToast('Rollups rebuilt')"
                      onsubmit="return confirm('Rebuild monthly rollups now?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-primary btn-lg w-full">Rebuild now</button>
                </form>
            </div>
        </article>
    </div>

    <div class="card shadow-hover">
        <div class="card-header">
            <h2 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">System information</h2>
        </div>
        <div class="card-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card" data-elevation="0">
                <div class="card-body space-y-1">
                    <p class="metric-eyebrow">App version</p>
                    <p class="font-semibold text-slate-800 dark:text-slate-100">{{ app_version }}</p>
                </div>
            </div>
            <div class="card" data-elevation="0">
                <div class="card-body space-y-1">
                    <p class="metric-eyebrow">Environment</p>
                    <p class="font-semibold text-slate-800 dark:text-slate-100">{{ environment }}</p>
                </div>
            </div>
            <div class="card" data-elevation="0">
                <div class="card-body space-y-1">
                    <p class="metric-eyebrow">Database</p>
                    <p class="font-semibold text-slate-800 dark:text-slate-100">{{ db_path }}</p>
                </div>
            </div>
            <div class="card" data-elevation="0">
                <div class="card-body space-y-1">
                    <p class="metric-eyebrow">DB size</p>
                    <p class="font-semibold text-slate-800 dark:text-slate-100">{{ db_size_mb }} MB</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
