<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Expense Report - {{ period.start }} to {{ period.end }}</title>
</head>
<body>
    <header style="text-align: center; margin-bottom: 30px;">
        <h1>Expense Report</h1>
        <p>{{ period.start }} - {{ period.end }}</p>
        {% if options.notes %}
        <p><strong>Notes:</strong> {{ options.notes }}</p>
        {% endif %}
    </header>

    {% if summary %}
    <section class="section">
        <h2>Summary</h2>
        <div class="kpi-grid">
            <div class="kpi-card">
                <h3>Total Income</h3>
                <p style="font-size: 18pt; color: green;">{{ summary.total_income|currency(options) }}{{ options.currency_symbol }}</p>
            </div>
            <div class="kpi-card">
                <h3>Total Expenses</h3>
                <p style="font-size: 18pt; color: red;">{{ summary.total_expenses|currency(options) }}{{ options.currency_symbol }}</p>
            </div>
            <div class="kpi-card">
                <h3>Balance</h3>
                <p style="font-size: 18pt; {% if summary.balance >= 0 %}color: green;{% else %}color: red;{% endif %}">{{ summary.balance|currency(options) }}{{ options.currency_symbol }}</p>
            </div>
        </div>
    </section>
    {% endif %}

    {% if kpis %}
    <section class="section">
        <h2>Key Performance Indicators</h2>
        <div class="kpi-grid">
            <div class="kpi-card">
                <h3>Income</h3>
                <p style="font-size: 16pt;">{{ kpis.income|currency(options) }}{{ options.currency_symbol }}</p>
            </div>
            <div class="kpi-card">
                <h3>Expenses</h3>
                <p style="font-size: 16pt;">{{ kpis.expenses|currency(options) }}{{ options.currency_symbol }}</p>
            </div>
            <div class="kpi-card">
                <h3>Balance</h3>
                <p style="font-size: 16pt; {% if kpis.balance >= 0 %}color: green;{% else %}color: red;{% endif %}">{{ kpis.balance|currency(options) }}{{ options.currency_symbol }}</p>
            </div>
        </div>
    </section>
    {% endif %}

    {% if category_breakdown %}
    <section class="section">
        <h2>Category Breakdown</h2>
        <div style="margin: 20px 0;">
            {% set total = category_breakdown | map(attribute='amount_cents') | sum %}
            {% set colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'] %}
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                {% for cat in category_breakdown %}
                    {% set color = colors[loop.index0 % colors|length] %}
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background-color: {{ color }}; border-radius: 3px;"></div>
                        <span>{{ cat.name }} ({{ "%.1f"|format(cat.percent) }}%)</span>
                    </div>
                {% endfor %}
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in category_breakdown %}
                <tr>
                    <td>{{ cat.name }}</td>
                    <td>{{ cat.amount_cents|currency(options) }}{{ options.currency_symbol }}</td>
                    <td>{{ "%.1f"|format(cat.percent) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    {% if top_categories %}
    <section class="section">
        <h2>Top 5 Categories</h2>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in top_categories %}
                <tr>
                    <td>{{ cat.name }}</td>
                    <td>{{ cat.amount_cents|currency(options) }}{{ options.currency_symbol }}</td>
                    <td>{{ "%.1f"|format(cat.percent) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    {% if trend %}
    <section class="section">
        <h2>Expense Trend</h2>
        <svg width="700" height="300" viewBox="0 0 700 300">
            {% set max_amount = trend | map(attribute='amount_cents') | max or 1 %}
            {% set padding = 50 %}
            {% set chart_width = 600 %}
            {% set chart_height = 200 %}
            <polyline points="{% for point in trend %}{{ padding + (loop.index0 * chart_width / (trend|length - 1)) }},{{ padding + chart_height - (point.amount_cents / max_amount * chart_height) }}{% if not loop.last %} {% endif %}{% endfor %}" fill="none" stroke="#2563eb" stroke-width="2"/>
            {% for point in trend %}
                <circle cx="{{ padding + (loop.index0 * chart_width / (trend|length - 1)) }}" cy="{{ padding + chart_height - (point.amount_cents / max_amount * chart_height) }}" r="3" fill="#2563eb"/>
            {% endfor %}
            <line x1="{{ padding }}" y1="{{ padding }}" x2="{{ padding }}" y2="{{ padding + chart_height }}" stroke="#333" stroke-width="1"/>
            <line x1="{{ padding }}" y1="{{ padding + chart_height }}" x2="{{ padding + chart_width }}" y2="{{ padding + chart_height }}" stroke="#333" stroke-width="1"/>
        </svg>
    </section>
    {% endif %}

    {% if recent_transactions %}
    <section class="section">
        <h2>Recent Transactions ({{ recent_transactions|length }})</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Note</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for txn in recent_transactions %}
                <tr>
                    <td>{{ txn.date }}</td>
                    <td>{{ txn.type.value }}</td>
                    <td>{{ txn.category.name if txn.category else 'N/A' }}</td>
                    <td>{{ txn.note or '' }}</td>
                    <td style="{% if txn.type.value == 'income' %}color: green;{% else %}color: red;{% endif %}">
                        {% if txn.type.value == 'income' %}+{% else %}-{% endif %}{{ txn.amount_cents|currency(options) }}{{ options.currency_symbol }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    {% if recurring_upcoming %}
    <section class="section">
        <h2>Upcoming Recurring Transactions</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Next Occurrence</th>
                    <th>Amount</th>
                    <th>Auto-post</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in recurring_upcoming %}
                <tr>
                    <td>{{ rule.name or 'Unnamed Rule' }}</td>
                    <td>{{ rule.type.value }}</td>
                    <td>{{ rule.category.name if rule.category else 'N/A' }}</td>
                    <td>{{ rule.next_occurrence }}</td>
                    <td>{{ rule.amount_cents|currency(options) }}{{ options.currency_symbol }}</td>
                    <td>{{ 'Yes' if rule.auto_post else 'No' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    <footer style="margin-top: 40px; text-align: center; color: #666; font-size: 9pt;">
        <p>Expense Tracker</p>
    </footer>
</body>
</html>
